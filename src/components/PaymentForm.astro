---
interface Props {
    loanId: string;
    balance: number;
}

const { loanId, balance } = Astro.props;
---

<div class="payment-form-container card">
    <h3 style="margin-bottom: 1.5rem; font-size: 1.25rem;">
        ðŸ’³ Registrar Pago
    </h3>

    <form id="payment-form" class="payment-form">
        <div class="form-group">
            <label for="payment-amount">Monto del Pago</label>
            <input
                type="number"
                id="payment-amount"
                name="amount"
                min="1"
                max={balance}
                step="0.01"
                required
                placeholder="Ingrese el monto"
            />
            <small style="color: var(--text-secondary);">
                Saldo pendiente: <strong id="balance-display"
                    >{
                        new Intl.NumberFormat("es-CO", {
                            style: "currency",
                            currency: "COP",
                            minimumFractionDigits: 0,
                        }).format(balance)
                    }</strong
                >
            </small>
        </div>

        <div class="form-group">
            <label for="payment-type">Tipo de Pago</label>
            <select id="payment-type" name="paymentType" required>
                <option value="partial">Abono Parcial</option>
                <option value="full">Pago Completo</option>
            </select>
        </div>

        <div class="form-group">
            <label for="payment-evidence">
                Evidencia de Pago <span style="color: var(--color-danger);"
                    >*</span
                >
            </label>
            <input
                type="file"
                id="payment-evidence"
                name="evidence"
                accept="image/*"
            />
            <small style="color: var(--text-secondary);">
                Sube una imagen del comprobante (mÃ¡x. 5MB)
            </small>
            <div id="evidence-preview" style="margin-top: 1rem; display: none;">
                <img
                    id="preview-image"
                    style="max-width: 100%; max-height: 200px; border-radius: 8px;"
                    alt="Preview"
                />
            </div>
        </div>

        <div class="form-group">
            <label for="payment-notes">Notas (Opcional)</label>
            <textarea
                id="payment-notes"
                name="notes"
                rows="3"
                placeholder="Agrega cualquier nota adicional sobre este pago..."
            ></textarea>
        </div>

        <div id="payment-message" style="display: none; margin-bottom: 1rem;">
        </div>

        <button type="submit" class="btn btn-primary" id="submit-payment-btn">
            ðŸ“¤ Registrar Pago
        </button>
    </form>
</div>

<script define:vars={{ loanId, balance }}>
    const form = document.getElementById("payment-form");
    const amountInput = document.getElementById("payment-amount");
    const typeSelect = document.getElementById("payment-type");
    const evidenceInput = document.getElementById("payment-evidence");
    const notesInput = document.getElementById("payment-notes");
    const messageDiv = document.getElementById("payment-message");
    const submitBtn = document.getElementById("submit-payment-btn");
    const previewDiv = document.getElementById("evidence-preview");
    const previewImage = document.getElementById("preview-image");

    let evidenceUrl = null;

    // Preview image when selected
    evidenceInput?.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewDiv.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    // Auto-select full payment when amount equals balance
    amountInput?.addEventListener("input", (e) => {
        const amount = parseFloat(e.target.value);
        if (amount === balance) {
            typeSelect.value = "full";
        }
    });

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const amount = parseFloat(amountInput.value);
        const paymentType = typeSelect.value;
        const notes = notesInput.value;
        const evidenceFile = evidenceInput.files[0];

        if (!evidenceFile) {
            showMessage("Recuerda subir una evidencia de pago", "error");
            // return;
        }

        if (amount > balance) {
            showMessage(
                `El monto no puede exceder el saldo pendiente (${formatCurrency(balance)})`,
                "error",
            );
            return;
        }

        submitBtn.disabled = true;

        try {
            // Upload evidence first
            if (evidenceFile) {
                submitBtn.textContent = "â³ Subiendo evidencia...";
                const formData = new FormData();
                formData.append("evidence", evidenceFile);

                const uploadResponse = await fetch("/api/upload-evidence", {
                    method: "POST",
                    body: formData,
                });

                const uploadData = await uploadResponse.json();

                if (!uploadData.success) {
                    throw new Error(
                        uploadData.error || "Error al subir evidencia",
                    );
                }
                evidenceUrl = uploadData.url;
            }

            // Create payment
            submitBtn.textContent = "â³ Registrando pago...";

            const paymentResponse = await fetch(
                `/api/loans/${loanId}/payments`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        amount,
                        paymentType,
                        evidenceUrl,
                        notes,
                    }),
                },
            );

            const paymentData = await paymentResponse.json();

            if (paymentData.success) {
                showMessage(
                    "âœ… Pago registrado exitosamente. Esperando confirmaciÃ³n del prestamista.",
                    "success",
                );
                form.reset();
                previewDiv.style.display = "none";

                // Reload page after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error(paymentData.error || "Error al registrar pago");
            }
        } catch (error) {
            showMessage(error.message || "Error al procesar el pago", "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "ðŸ“¤ Registrar Pago";
        }
    });

    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.style.display = "block";
        messageDiv.style.padding = "1rem";
        messageDiv.style.borderRadius = "8px";

        if (type === "success") {
            messageDiv.style.background = "rgba(34, 197, 94, 0.1)";
            messageDiv.style.border = "1px solid rgba(34, 197, 94, 0.3)";
            messageDiv.style.color = "#22c55e";
        } else {
            messageDiv.style.background = "rgba(239, 68, 68, 0.1)";
            messageDiv.style.border = "1px solid rgba(239, 68, 68, 0.3)";
            messageDiv.style.color = "#ef4444";
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat("es-CO", {
            style: "currency",
            currency: "COP",
            minimumFractionDigits: 0,
        }).format(amount);
    }
</script>

<style>
    .payment-form-container {
        background: linear-gradient(
            135deg,
            rgba(139, 92, 246, 0.1),
            rgba(96, 165, 250, 0.1)
        );
        border-color: rgba(139, 92, 246, 0.3);
    }

    .payment-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 600;
        color: var(--text-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: hsl(260, 85%, 65%);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .form-group input[type="file"] {
        padding: 0.5rem;
    }
</style>
