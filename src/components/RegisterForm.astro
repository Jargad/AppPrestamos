---
// Register Form Component - Updated for SSR
---

<div class="auth-form">
    <h2
        style="margin-bottom: 1.5rem; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
    >
        âœ¨ Crear Cuenta
    </h2>

    <form id="register-form">
        <div class="input-group">
            <label for="register-username">Nombre de Usuario</label>
            <input
                type="text"
                id="register-username"
                name="username"
                required
                placeholder="Ej: Juan123"
            />
        </div>

        <div class="input-group">
            <label for="register-email">Email</label>
            <input
                type="email"
                id="register-email"
                name="email"
                required
                placeholder="tu@email.com"
            />
        </div>

        <div class="input-group">
            <label for="register-password">ContraseÃ±a</label>
            <input
                type="password"
                id="register-password"
                name="password"
                required
                minlength="6"
                placeholder="MÃ­nimo 6 caracteres"
            />
        </div>

        <div class="input-group">
            <label for="register-confirm-password">Confirmar ContraseÃ±a</label>
            <input
                type="password"
                id="register-confirm-password"
                name="confirmPassword"
                required
                minlength="6"
                placeholder="Repite tu contraseÃ±a"
            />
        </div>

        <div class="input-group">
            <label for="register-phone">WhatsApp (Opcional)</label>
            <input
                type="tel"
                id="register-phone"
                name="phone"
                placeholder="+57 300 123 4567"
                pattern="\+[1-9]\d{1,14}"
                title="Formato internacional: +57 300 123 4567"
            />
            <small
                style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;"
            >
                ðŸ“± Para recibir notificaciones por WhatsApp
            </small>
        </div>

        <div id="register-error" class="error-message" style="display: none;">
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">
            ðŸŽ‰ Registrarse
        </button>
    </form>
</div>

<script>
    const form = document.getElementById("register-form") as HTMLFormElement;
    const errorDiv = document.getElementById("register-error");

    // Pre-fill email if provided in URL
    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get("email");
    if (emailParam) {
        const emailInput = document.getElementById(
            "register-email",
        ) as HTMLInputElement;
        if (emailInput) emailInput.value = emailParam;
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const username = formData.get("username") as string;
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;
        const confirmPassword = formData.get("confirmPassword") as string;
        const phone = formData.get("phone") as string;

        // Validate passwords match
        if (password !== confirmPassword) {
            if (errorDiv) {
                errorDiv.textContent = "Las contraseÃ±as no coinciden";
                errorDiv.style.display = "block";
            }
            return;
        }

        // Validate password length
        if (password.length < 6) {
            if (errorDiv) {
                errorDiv.textContent =
                    "La contraseÃ±a debe tener al menos 6 caracteres";
                errorDiv.style.display = "block";
            }
            return;
        }

        try {
            const response = await fetch("/api/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username,
                    email,
                    password,
                    phone: phone || undefined,
                }),
            });

            const data = await response.json();

            if (data.success) {
                // Check if there's a redirect parameter
                const redirect = urlParams.get("redirect");
                window.location.href = redirect || "/";
            } else {
                if (errorDiv) {
                    errorDiv.textContent = data.error || "Error al registrarse";
                    errorDiv.style.display = "block";
                }
            }
        } catch (error) {
            if (errorDiv) {
                errorDiv.textContent = "Error de conexiÃ³n. Intenta nuevamente.";
                errorDiv.style.display = "block";
            }
        }
    });
</script>

<style>
    .auth-form {
        width: 100%;
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
</style>
