---
import LoanForm from "../components/LoanForm.astro";
import ContactsManager from "../components/ContactsManager.astro";
import MenuButton from "../components/MenuButton.astro";
import NavigationMenu from "../components/NavigationMenu.astro";
import "../styles/global.css";

// Check authentication
const sessionCookie = Astro.cookies.get("session");
if (!sessionCookie) {
	return Astro.redirect("/auth");
}

let session;
try {
	session = JSON.parse(sessionCookie.value);
} catch {
	return Astro.redirect("/auth");
}
---

<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/logo.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta
			name="description"
			content="Gestiona tus prÃ©stamos de forma sencilla y organizada"
		/>
		<title>Gestor de PrÃ©stamos</title>
	</head>
	<body>
		<NavigationMenu />
		<div class="container">
			<header class="main-header">
				<div class="header-user-section">
					<MenuButton />
					<span id="user-info" class="user-info">
						ğŸ‘¤ {session.username}
					</span>
				</div>
				<div class="header-content">
					<h1 class="header-title">ğŸ’¸ Gestor de PrÃ©stamos</h1>
					<p class="header-subtitle">
						Administra y da seguimiento a tus prÃ©stamos de forma
						profesional
					</p>
				</div>
			</header>

			<div class="grid grid-2" style="margin-bottom: 3rem;">
				<LoanForm />

				<div
					class="card"
					style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(96, 165, 250, 0.1)); border-color: rgba(139, 92, 246, 0.3);"
				>
					<h3 style="margin-bottom: 1rem; font-size: 1.25rem;">
						ğŸ“Š EstadÃ­sticas
					</h3>
					<div id="stats" style="display: grid; gap: 1rem;">
						<div
							style="display: flex; justify-content: space-between; align-items: center;"
						>
							<span style="color: var(--text-secondary);"
								>PrÃ©stamos Activos Dados:</span
							>
							<strong id="lent-count" style="font-size: 1.5rem;"
								>0</strong
							>
						</div>
						<div
							style="display: flex; justify-content: space-between; align-items: center;"
						>
							<span style="color: var(--text-secondary);"
								>PrÃ©stamos Activos Recibidos:</span
							>
							<strong
								id="borrowed-count"
								style="font-size: 1.5rem;">0</strong
							>
						</div>
						<div
							style="display: flex; justify-content: space-between; align-items: center;"
						>
							<span style="color: var(--text-secondary);"
								>Pendientes de Aceptar:</span
							>
							<strong
								id="pending-count"
								style="font-size: 1.5rem; color: var(--color-warning);"
								>0</strong
							>
						</div>
						<div
							style="display: flex; justify-content: space-between; align-items: center;"
						>
							<span style="color: var(--text-secondary);"
								>Total Prestado:</span
							>
							<strong
								id="total-lent"
								style="font-size: 1.5rem; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
								>$0</strong
							>
						</div>
						<div
							style="display: flex; justify-content: space-between; align-items: center;"
						>
							<span style="color: var(--text-secondary);"
								>Total Debido:</span
							>
							<strong
								id="total-owed"
								style="font-size: 1.5rem; background: linear-gradient(135deg, hsl(355, 75%, 60%), hsl(40, 95%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
								>$0</strong
							>
						</div>
					</div>

					<!-- Chart Section -->
					<div style="margin-top: 2rem;">
						<h4
							style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-secondary);"
						>
							ğŸ’° PrÃ©stamos por Contacto
						</h4>
						<div
							id="contact-chart"
							style="display: grid; gap: 0.75rem;"
						>
							<!-- Chart bars will be inserted here -->
						</div>
					</div>
				</div>
			</div>

			<!-- Contacts Section with Grid -->
			<div style="margin-bottom: 3rem;">
				<ContactsManager />
			</div>

			<!-- Two Column Layout for Loans -->
			<div class="grid grid-2" style="gap: 2rem; align-items: start;">
				<!-- Left Column: Loans I've Given (as Lender) -->
				<div class="loan-section">
					<div
						class="loan-section-header"
						id="lender-loans-header"
						style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; cursor: pointer; user-select: none;"
					>
						<h2
							style="margin: 0; font-size: 1.75rem; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; display: flex; align-items: center; gap: 0.5rem;"
						>
							ğŸ’° PrÃ©stamos que he Dado
							<span
								id="lender-toggle-icon"
								style="transition: transform 0.3s ease; font-size: 0.5em; opacity: 0.7;"
								>â–¼</span
							>
						</h2>
					</div>
					<div
						id="lender-loans-content"
						class="loan-section-content"
						style="max-height: 600px; overflow-y: auto; overflow-x: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 1;"
					>
						<div id="lender-loans-list" class="loans-grid"></div>
						<div
							id="lender-empty-state"
							style="text-align: center; padding: 3rem; color: var(--text-tertiary); display: none;"
						>
							<p
								style="font-size: 1.2rem; margin-bottom: 0.5rem;"
							>
								ğŸ“­ No has dado prÃ©stamos aÃºn
							</p>
							<p>
								Crea tu primer prÃ©stamo usando el formulario de
								arriba
							</p>
						</div>
					</div>
				</div>

				<!-- Right Column: Loans I Owe (as Borrower) + Pending Invitations -->
				<div class="loan-section">
					<div
						class="loan-section-header"
						id="borrower-loans-header"
						style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; cursor: pointer; user-select: none;"
					>
						<h2
							style="margin: 0; font-size: 1.75rem; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; display: flex; align-items: center; gap: 0.5rem;"
						>
							ğŸ’³ PrÃ©stamos que Debo
							<span
								id="borrower-toggle-icon"
								style="transition: transform 0.3s ease; font-size: 0.5em; opacity: 0.7;"
								>â–¼</span
							>
						</h2>
					</div>
					<div
						id="borrower-loans-content"
						class="loan-section-content"
						style="max-height: 600px; overflow-y: auto; overflow-x: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; opacity: 1;"
					>
						<!-- Pending Invitations (shown first if any) -->
						<div id="pending-section" style="margin-bottom: 2rem;">
							<div id="pending-loans-list" class="loans-grid">
							</div>
							<div
								id="pending-empty-state"
								style="display: none;"
							>
							</div>
						</div>

						<!-- Accepted Borrower Loans -->
						<div id="borrower-loans-list" class="loans-grid"></div>
						<div
							id="borrower-empty-state"
							style="text-align: center; padding: 3rem; color: var(--text-tertiary); display: none;"
						>
							<p
								style="font-size: 1.2rem; margin-bottom: 0.5rem;"
							>
								ğŸ“­ No tienes prÃ©stamos pendientes
							</p>
							<p>
								Cuando alguien te envÃ­e un prÃ©stamo, aparecerÃ¡
								aquÃ­
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			// Format currency
			function formatCurrency(amount: number): string {
				return new Intl.NumberFormat("es-CO", {
					style: "currency",
					currency: "COP",
					minimumFractionDigits: 0,
				}).format(amount);
			}

			// Format date
			function formatDate(dateString: string): string {
				return new Intl.DateTimeFormat("es-CO", {
					year: "numeric",
					month: "long",
					day: "numeric",
				}).format(new Date(dateString));
			}

			// Mark loan as returned
			async function markAsReturned(loanId: string) {
				try {
					const response = await fetch(
						`/api/loans/${loanId}/return`,
						{
							method: "POST",
						},
					);
					const data = await response.json();
					if (data.success) {
						loadLoans();
					} else {
						alert(data.error || "Error al marcar como devuelto");
					}
				} catch (error) {
					alert("Error de conexiÃ³n");
				}
			}

			// Delete loan
			async function deleteLoan(loanId: string) {
				try {
					const response = await fetch(`/api/loans/${loanId}`, {
						method: "DELETE",
					});
					const data = await response.json();
					if (data.success) {
						loadLoans();
					} else {
						alert(data.error || "Error al eliminar prÃ©stamo");
					}
				} catch (error) {
					alert("Error de conexiÃ³n");
				}
			}

			// Load loans from API
			async function loadLoans() {
				try {
					const response = await fetch("/api/loans");
					const data = await response.json();

					if (data.success) {
						updateStats(
							data.loansAsLender || [],
							data.loansAsBorrower || [],
							data.pendingLoans || [],
						);
						renderLenderLoans(data.loansAsLender || []);
						renderBorrowerLoans(data.loansAsBorrower || []);
						renderPendingLoans(data.pendingLoans || []);
					}
				} catch (error) {
					console.error("Error loading loans:", error);
				}
			}

			// Render lender loans
			function renderLenderLoans(loans: any[]) {
				const list = document.getElementById("lender-loans-list");
				const emptyState =
					document.getElementById("lender-empty-state");

				if (!list || !emptyState) return;

				const activeLoans = loans.filter(
					(loan) =>
						loan.status !== "returned" &&
						loan.status !== "rejected",
				);

				// Sort loans: 1) Accepted status first, 2) Pending payments, 3) Non-personal loans, 4) Creation date
				const sortedLoans = activeLoans.sort((a, b) => {
					// First priority: accepted status comes before pending
					if (a.status === "accepted" && b.status !== "accepted")
						return -1;
					if (a.status !== "accepted" && b.status === "accepted")
						return 1;

					// Second priority: loans with pending payments (only for accepted loans)
					const aPendingPayments = a.pendingPaymentsCount || 0;
					const bPendingPayments = b.pendingPaymentsCount || 0;
					if (aPendingPayments > 0 && bPendingPayments === 0)
						return -1;
					if (aPendingPayments === 0 && bPendingPayments > 0)
						return 1;

					// Third priority: non-personal loans before personal loans
					const aIsPersonal = a.is_personal === 1;
					const bIsPersonal = b.is_personal === 1;
					if (!aIsPersonal && bIsPersonal) return -1;
					if (aIsPersonal && !bIsPersonal) return 1;

					// Fourth priority: sort by creation date (newest first)
					return (
						new Date(b.created_at).getTime() -
						new Date(a.created_at).getTime()
					);
				});

				if (sortedLoans.length === 0) {
					list.style.display = "none";
					emptyState.style.display = "block";
				} else {
					list.style.display = "grid";
					emptyState.style.display = "none";

					list.innerHTML = sortedLoans
						.map((loan) => {
							const statusText: Record<string, string> = {
								pending: "â³ Pendiente de AceptaciÃ³n",
								accepted: "âœ… Aceptado",
								rejected: "âŒ Rechazado",
								returned: "ğŸ’µ Devuelto",
							};

							// Determine available actions based on status
							let actions = "";
							if (loan.status === "accepted") {
								actions = `
							<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
								<a href="/loans/${loan.id}" class="btn btn-primary" style="flex: 1; text-decoration: none; text-align: center;">
									ğŸ“Š Ver Detalles y Pagos
								</a>
							</div>
						`;
							} else if (
								loan.status === "pending" ||
								loan.status === "rejected"
							) {
								actions = `
							<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
								<button class="btn btn-danger delete-loan-btn" data-id="${loan.id}" style="flex: 1;">
									ğŸ—‘ï¸ Eliminar
								</button>
							</div>
						`;
							} else if (loan.status === "returned") {
								actions = `
							<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
								<a href="/loans/${loan.id}" class="btn btn-primary" style="flex: 1; text-decoration: none; text-align: center;">
									ğŸ“Š Ver Detalles y Pagos
								</a>
							</div>
						`;
							}

							// Add pending payments indicator
							let pendingPaymentsBadge = "";
							if (
								loan.pendingPaymentsCount &&
								loan.pendingPaymentsCount > 0
							) {
								pendingPaymentsBadge = `
							<div style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; padding: 0.5rem 1rem; border-radius: 8px; margin-top: 1rem; font-weight: 600; text-align: center; animation: pulse 2s infinite;">
								ğŸ”” ${loan.pendingPaymentsCount} pago${loan.pendingPaymentsCount > 1 ? "s" : ""} pendiente${loan.pendingPaymentsCount > 1 ? "s" : ""} de confirmar
							</div>
						`;
							}

							return `
						<div class="loan-card card ${loan.pendingPaymentsCount > 0 ? "loan-with-pending-payments" : ""}">
							<div class="loan-header">
								<div>
									<h3 class="loan-borrower">${loan.is_personal ? "ğŸ“ " : ""}PrÃ©stamo a ${loan.borrower_name}</h3>
									<p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.25rem 0;">
										ğŸ“§ ${loan.borrower_email}
									</p>
									<p class="loan-date">${formatDate(loan.created_at)}</p>
								</div>
								<span class="badge badge-${loan.status}">${statusText[loan.status] || loan.status}</span>
							</div>
							<div class="loan-body">
								<div class="loan-amount">${formatCurrency(loan.amount)}</div>
								<p class="loan-description">${loan.description}</p>
								${pendingPaymentsBadge}
								${actions}
							</div>
						</div>
					`;
						})
						.join("");

					// Attach event listeners for actions
					document
						.querySelectorAll(".mark-returned-btn")
						.forEach((btn) => {
							btn.addEventListener("click", async () => {
								const loanId = (btn as HTMLElement).dataset.id;
								if (
									loanId &&
									confirm(
										"Â¿Marcar este prÃ©stamo como devuelto?",
									)
								) {
									await markAsReturned(loanId);
								}
							});
						});

					document
						.querySelectorAll(".delete-loan-btn")
						.forEach((btn) => {
							btn.addEventListener("click", async () => {
								const loanId = (btn as HTMLElement).dataset.id;
								if (
									loanId &&
									confirm(
										"Â¿EstÃ¡s seguro de eliminar este prÃ©stamo?",
									)
								) {
									await deleteLoan(loanId);
								}
							});
						});
				}
			} // Render borrower loans
			function renderBorrowerLoans(loans: any[]) {
				const list = document.getElementById("borrower-loans-list");
				const emptyState = document.getElementById(
					"borrower-empty-state",
				);

				if (!list || !emptyState) return;

				const activeLoans = loans.filter(
					(loan) =>
						loan.status !== "returned" &&
						loan.status !== "rejected",
				);

				// Sort loans: accepted first, then pending
				const sortedLoans = activeLoans.sort((a, b) => {
					// First priority: accepted status comes before pending
					if (a.status === "accepted" && b.status !== "accepted")
						return -1;
					if (a.status !== "accepted" && b.status === "accepted")
						return 1;

					// Second priority: sort by creation date (newest first)
					return (
						new Date(b.created_at).getTime() -
						new Date(a.created_at).getTime()
					);
				});

				if (sortedLoans.length === 0) {
					list.style.display = "none";
					emptyState.style.display = "block";
				} else {
					list.style.display = "grid";
					emptyState.style.display = "none";

					list.innerHTML = sortedLoans
						.map((loan) => {
							const statusText: Record<string, string> = {
								accepted: "âœ… Aceptado",
								returned: "ğŸ’µ Devuelto",
							};

							// Determine available actions based on status
							let actions = "";
							console.log("Loan Status:", loan.status);
							if (loan.status === "accepted") {
								actions = `
									<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
										<a href="/loans/${loan.id}" class="btn btn-primary" style="flex: 1; text-decoration: none; text-align: center;">
											ğŸ’³ Registrar Pago
										</a>
										<a href="/loans/${loan.id}" class="btn btn-secondary" style="flex: 1; text-decoration: none; text-align: center;">
											ğŸ“Š Ver Detalles
										</a>
									</div>
								`;
							} else if (loan.status === "returned") {
								actions = `
									<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
										<a href="/loans/${loan.id}" class="btn btn-secondary" style="flex: 1; text-decoration: none; text-align: center;">
											ğŸ“Š Ver Detalles
										</a>
									</div>
								`;
							}

							return `
								<div class="loan-card card">
									<div class="loan-header">
										<div>
											<h3 class="loan-borrower">${loan.is_personal ? "ğŸ“ " : ""}PrÃ©stamo de ${loan.lender_name || "Desconocido"}</h3>
											<p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.25rem 0;">
												ğŸ“§ ${loan.lender_email || ""}
											</p>
											<p class="loan-date">${formatDate(loan.created_at)}</p>
										</div>
										<span class="badge badge-${loan.status}">${statusText[loan.status] || loan.status}</span>
									</div>
									<div class="loan-body">
										<div class="loan-amount">${formatCurrency(loan.amount)}</div>
										<p class="loan-description">${loan.description}</p>
										${actions}
									</div>
								</div>
							`;
						})
						.join("");
				}
			}

			// Render pending invitations
			function renderPendingLoans(loans: any[]) {
				const list = document.getElementById("pending-loans-list");
				const emptyState = document.getElementById(
					"pending-empty-state",
				);

				if (!list || !emptyState) return;

				if (loans.length === 0) {
					list.style.display = "none";
					emptyState.style.display = "block";
				} else {
					list.style.display = "grid";
					emptyState.style.display = "none";

					list.innerHTML = loans
						.map((loan) => {
							return `
							<div class="loan-card card" style="border-color: var(--color-warning);">
								<div class="loan-header">
									<div>
										<h3 class="loan-borrower">${loan.borrower_name}</h3>
										<p class="loan-date">${formatDate(loan.created_at)}</p>
									</div>
									<span class="badge badge-pending">â³ Pendiente</span>
								</div>
								<div class="loan-body">
									<div class="loan-amount">${formatCurrency(loan.amount)}</div>
									<p class="loan-description">${loan.description}</p>
									<div style="margin-top: 1.5rem;">
										<a href="/invitation/${loan.invitation_token}" class="btn btn-primary" style="width: 100%; text-decoration: none; display: inline-block; text-align: center;">
											Ver InvitaciÃ³n
										</a>
									</div>
								</div>
							</div>
						`;
						})
						.join("");
				}
			}

			// Update statistics
			function updateStats(
				lenderLoans: any[],
				borrowerLoans: any[],
				pendingLoans: any[],
			) {
				const lentCount = document.getElementById("lent-count");
				const borrowedCount = document.getElementById("borrowed-count");
				const pendingCount = document.getElementById("pending-count");
				const totalLent = document.getElementById("total-lent");
				const totalOwed = document.getElementById("total-owed");

				// Filter only active loans (accepted and pending)
				const activeLenderLoans = lenderLoans.filter(
					(l) => l.status === "accepted" || l.status === "pending",
				);
				const activeBorrowerLoans = borrowerLoans.filter(
					(l) => l.status === "accepted",
				);

				if (lentCount)
					lentCount.textContent = activeLenderLoans.length.toString();
				if (borrowedCount)
					borrowedCount.textContent =
						activeBorrowerLoans.length.toString();
				if (pendingCount)
					pendingCount.textContent = pendingLoans.length.toString();

				if (totalLent) {
					const total = activeLenderLoans.reduce(
						(sum, l) => sum + l.amount,
						0,
					);
					totalLent.textContent = formatCurrency(total);
				}

				if (totalOwed) {
					const total = activeBorrowerLoans.reduce(
						(sum, l) => sum + l.amount,
						0,
					);
					totalOwed.textContent = formatCurrency(total);
				}

				// Update contact chart
				updateContactChart(activeLenderLoans);
			}

			// Update contact chart
			function updateContactChart(loans: any[]) {
				const chartContainer = document.getElementById("contact-chart");
				if (!chartContainer) return;

				// Group loans by contact
				const contactMap = new Map<
					string,
					{ name: string; total: number }
				>();

				loans.forEach((loan) => {
					const key = loan.borrower_email;
					if (contactMap.has(key)) {
						contactMap.get(key)!.total += loan.amount;
					} else {
						contactMap.set(key, {
							name: loan.borrower_name,
							total: loan.amount,
						});
					}
				});

				// Convert to array and sort by total descending
				const contacts = Array.from(contactMap.values()).sort(
					(a, b) => b.total - a.total,
				);

				if (contacts.length === 0) {
					chartContainer.innerHTML = `
					<p style="text-align: center; color: var(--text-tertiary); padding: 1rem;">
						No hay prÃ©stamos activos para mostrar
					</p>
				`;
					return;
				}

				// Calculate total and percentages
				const total = contacts.reduce((sum, c) => sum + c.total, 0);

				// Define colors
				const colors = [
					"hsl(260, 85%, 65%)",
					"hsl(200, 90%, 60%)",
					"hsl(145, 65%, 55%)",
					"hsl(40, 95%, 60%)",
					"hsl(355, 75%, 60%)",
					"hsl(280, 75%, 65%)",
					"hsl(170, 80%, 55%)",
				];

				// Create donut chart
				const size = 250;
				const strokeWidth = 30;
				const radius = (size - strokeWidth) / 2;
				const circumference = 2 * Math.PI * radius;

				let currentAngle = 0;
				const segments = contacts.map((contact, index) => {
					const percentage = (contact.total / total) * 100;
					const angle = (percentage / 100) * 360;
					const color = colors[index % colors.length];

					const segment = {
						contact,
						percentage,
						angle,
						startAngle: currentAngle,
						color,
					};

					currentAngle += angle;
					return segment;
				});

				// Generate SVG donut chart
				const svgSegments = segments
					.map((seg) => {
						const startAngle =
							(seg.startAngle - 90) * (Math.PI / 180);
						const endAngle =
							(seg.startAngle + seg.angle - 90) * (Math.PI / 180);

						const x1 = size / 2 + radius * Math.cos(startAngle);
						const y1 = size / 2 + radius * Math.sin(startAngle);
						const x2 = size / 2 + radius * Math.cos(endAngle);
						const y2 = size / 2 + radius * Math.sin(endAngle);

						const largeArc = seg.angle > 180 ? 1 : 0;

						const pathData = [
							`M ${x1} ${y1}`,
							`A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
						].join(" ");

						return `
					<path
						d="${pathData}"
						fill="none"
						stroke="${seg.color}"
						stroke-width="${strokeWidth}"
						stroke-linecap="round"
						class="chart-segment"
						style="cursor: pointer; transition: opacity 0.3s ease;"
						onmouseover="this.style.opacity='0.7'"
						onmouseout="this.style.opacity='1'"
					/>
				`;
					})
					.join("");

				// Generate legend
				const legend = segments
					.map((seg, index) => {
						return `
					<div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; transition: background 0.2s ease;" 
						onmouseover="this.style.background='var(--bg-hover)'" 
						onmouseout="this.style.background='transparent'">
						<div style="width: 16px; height: 16px; border-radius: 4px; background: ${seg.color}; flex-shrink: 0;"></div>
						<div style="flex: 1; min-width: 0;">
							<div style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
								${seg.contact.name}
							</div>
							<div style="font-size: 0.85rem; color: var(--text-secondary);">
								${formatCurrency(seg.contact.total)} (${seg.percentage.toFixed(1)}%)
							</div>
						</div>
					</div>
				`;
					})
					.join("");

				chartContainer.innerHTML = `
				<div style="display: grid; gap: 1.5rem; grid-template-columns: auto 1fr; align-items: center;">
					<div style="position: relative; width: ${size}px; height: ${size}px;">
						<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="transform: rotate(0deg);">
							${svgSegments}
						</svg>
						<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
							<div style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
								${formatCurrency(total)}
							</div>
							<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
								Total
							</div>
						</div>
					</div>
					<div style="display: grid; gap: 0.5rem; max-height: ${size}px; overflow-y: auto; padding-right: 0.5rem;">
						${legend}
					</div>
				</div>
			`;
			}

			// Listen for loan created event
			window.addEventListener("loan-created", () => {
				loadLoans();
			});

			// Toggle loan sections visibility
			const lenderLoansContent = document.getElementById(
				"lender-loans-content",
			);
			const lenderToggleIcon =
				document.getElementById("lender-toggle-icon");
			const lenderLoansHeader = document.getElementById(
				"lender-loans-header",
			);

			const borrowerLoansContent = document.getElementById(
				"borrower-loans-content",
			);
			const borrowerToggleIcon = document.getElementById(
				"borrower-toggle-icon",
			);
			const borrowerLoansHeader = document.getElementById(
				"borrower-loans-header",
			);

			let isLenderVisible =
				localStorage.getItem("lenderLoansVisible") !== "false";
			let isBorrowerVisible =
				localStorage.getItem("borrowerLoansVisible") !== "false";

			// Set visibility for lender loans
			function setLenderVisibility(visible: boolean) {
				if (
					!lenderLoansContent ||
					!lenderToggleIcon ||
					!lenderLoansHeader
				)
					return;

				if (visible) {
					lenderLoansContent.style.maxHeight = "600px";
					lenderLoansContent.style.opacity = "1";
					lenderToggleIcon.style.transform = "rotate(0deg)";
					lenderLoansHeader.style.marginBottom = "1.5rem";
				} else {
					lenderLoansContent.style.maxHeight = "0";
					lenderLoansContent.style.opacity = "0";
					lenderToggleIcon.style.transform = "rotate(-90deg)";
					lenderLoansHeader.style.marginBottom = "0";
				}

				localStorage.setItem("lenderLoansVisible", visible.toString());
			}

			// Set visibility for borrower loans
			function setBorrowerVisibility(visible: boolean) {
				if (
					!borrowerLoansContent ||
					!borrowerToggleIcon ||
					!borrowerLoansHeader
				)
					return;

				if (visible) {
					borrowerLoansContent.style.maxHeight = "600px";
					borrowerLoansContent.style.opacity = "1";
					borrowerToggleIcon.style.transform = "rotate(0deg)";
					borrowerLoansHeader.style.marginBottom = "1.5rem";
				} else {
					borrowerLoansContent.style.maxHeight = "0";
					borrowerLoansContent.style.opacity = "0";
					borrowerToggleIcon.style.transform = "rotate(-90deg)";
					borrowerLoansHeader.style.marginBottom = "0";
				}

				localStorage.setItem(
					"borrowerLoansVisible",
					visible.toString(),
				);
			}

			// Initialize visibility
			setLenderVisibility(isLenderVisible);
			setBorrowerVisibility(isBorrowerVisible);

			// Toggle on header click
			lenderLoansHeader?.addEventListener("click", () => {
				isLenderVisible = !isLenderVisible;
				setLenderVisibility(isLenderVisible);
			});

			borrowerLoansHeader?.addEventListener("click", () => {
				isBorrowerVisible = !isBorrowerVisible;
				setBorrowerVisibility(isBorrowerVisible);
			});

			// Initial load
			loadLoans();
		</script>

		<style>
			/* Header Styles */
			.main-header {
				text-align: center;
				margin-bottom: 3rem;
				position: relative;
			}

			.header-user-section {
				display: flex;
				align-items: center;
				justify-content: flex-end;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.user-info {
				color: var(--text-secondary);
				font-size: 0.9rem;
			}

			.logout-btn {
				padding: 0.5rem 1rem;
				font-size: 0.9rem;
			}

			.header-content {
				margin-top: 1rem;
			}

			.header-title {
				font-size: 3rem;
				margin-bottom: 0.5rem;
				background: linear-gradient(
					135deg,
					hsl(260, 85%, 65%),
					hsl(200, 90%, 60%)
				);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.header-subtitle {
				color: var(--text-secondary);
				font-size: 1.1rem;
			}

			/* Loan Section Styles */
			.loan-section-header:hover {
				opacity: 0.9;
			}

			.loan-section-content {
				transition:
					max-height 0.3s ease,
					opacity 0.3s ease;
				padding: 3px;
			}

			.loan-section-content::-webkit-scrollbar {
				width: 8px;
			}

			.loan-section-content::-webkit-scrollbar-track {
				background: var(--bg-tertiary);
				border-radius: 4px;
			}

			.loan-section-content::-webkit-scrollbar-thumb {
				background: var(--bg-hover);
				border-radius: 4px;
			}

			.loan-section-content::-webkit-scrollbar-thumb:hover {
				background: rgba(139, 92, 246, 0.5);
			}

			.loan-card {
				animation: slideUp 0.3s ease;
			}

			.loan-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 1rem;
				gap: 1rem;
			}

			.loan-borrower {
				font-size: 1.25rem;
				font-weight: 600;
				margin-bottom: 0.25rem;
				color: var(--text-primary);
			}

			.loan-date {
				font-size: 0.85rem;
				color: var(--text-tertiary);
			}

			.loan-body {
				margin-bottom: 1.5rem;
			}

			.loan-amount {
				font-size: 2rem;
				font-weight: 700;
				background: linear-gradient(
					135deg,
					hsl(260, 85%, 65%),
					hsl(200, 90%, 60%)
				);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				margin-bottom: 0.5rem;
			}

			.loan-description {
				color: var(--text-secondary);
				line-height: 1.6;
			}

			.loans-grid {
				display: grid;
				grid-template-columns: 1fr;
				gap: 1.5rem;
			}

			@keyframes slideUp {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.7;
				}
			}

			/* Responsive Styles */
			@media (max-width: 968px) {
				.grid-2 {
					grid-template-columns: 1fr !important;
				}
			}

			@media (max-width: 768px) {
				.header-user-section {
					flex-direction: column;
					align-items: stretch;
					gap: 0.5rem;
				}

				.user-info {
					text-align: center;
					font-size: 0.85rem;
				}

				.logout-btn {
					width: 100%;
				}

				.header-title {
					font-size: 2rem;
				}

				.header-subtitle {
					font-size: 0.95rem;
				}

				/* Make chart responsive */
				#contact-chart > div {
					grid-template-columns: 1fr !important;
					justify-items: center;
				}
			}

			@media (max-width: 480px) {
				.header-title {
					font-size: 1.75rem;
				}

				.header-subtitle {
					font-size: 0.9rem;
				}
			}
		</style>
	</body>
</html>
