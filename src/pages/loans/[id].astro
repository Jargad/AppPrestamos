---
import PaymentForm from "../../components/PaymentForm.astro";
import PaymentHistory from "../../components/PaymentHistory.astro";
import "../../styles/global.css";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/");
}

// Check authentication
const sessionCookie = Astro.cookies.get("session");
if (!sessionCookie) {
    return Astro.redirect("/auth");
}

let session;
try {
    session = JSON.parse(sessionCookie.value);
} catch {
    return Astro.redirect("/auth");
}

// Fetch loan details
let loan = null;
let balance = null;
let isLender = false;
let isBorrower = false;

try {
    const loanResponse = await fetch(
        `${import.meta.env.APP_URL || "http://localhost:4321"}/api/loans`,
        {
            headers: {
                Cookie: `session=${sessionCookie.value}`,
            },
        },
    );
    const loansData = await loanResponse.json();

    if (loansData.success) {
        // Find the loan in either lender or borrower lists
        loan =
            loansData.loansAsLender?.find((l: any) => l.id === id) ||
            loansData.loansAsBorrower?.find((l: any) => l.id === id);

        if (loan) {
            isLender = loan.lender_id === session.userId;
            isBorrower = loan.borrower_id === session.userId;

            // Fetch balance
            const paymentsResponse = await fetch(
                `${import.meta.env.APP_URL || "http://localhost:4321"}/api/loans/${id}/payments`,
                {
                    headers: {
                        Cookie: `session=${sessionCookie.value}`,
                    },
                },
            );
            const paymentsData = await paymentsResponse.json();
            console.log("üîç Payments API Response:", paymentsData);
            if (paymentsData.success) {
                balance = paymentsData.balance;
                console.log("üí∞ Balance:", balance);
            } else {
                console.error(
                    "‚ùå Error fetching payments:",
                    paymentsData.error,
                );
            }
        }
    }
} catch (error) {
    console.error("Error fetching loan:", error);
}

if (!loan) {
    return Astro.redirect("/");
}

console.log("üìã Loan Details:", {
    id: loan.id,
    status: loan.status,
    isLender,
    isBorrower,
    balance,
});

const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("es-CO", {
        style: "currency",
        currency: "COP",
        minimumFractionDigits: 0,
    }).format(amount);
};

const formatDate = (dateString: string) => {
    return new Intl.DateTimeFormat("es-CO", {
        year: "numeric",
        month: "long",
        day: "numeric",
    }).format(new Date(dateString));
};

const statusText: Record<string, string> = {
    pending: "‚è≥ Pendiente de Aceptaci√≥n",
    accepted: "‚úÖ Aceptado",
    rejected: "‚ùå Rechazado",
    returned: "üíµ Devuelto",
};
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/logo.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>Detalles del Pr√©stamo - Gestor de Pr√©stamos</title>
    </head>
    <body>
        <div class="container" style="max-width: 1200px;">
            <header style="margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <a href="/" class="btn btn-secondary">‚Üê Volver</a>
                    <h1
                        style="font-size: 2rem; margin: 0; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
                    >
                        Detalles del Pr√©stamo
                    </h1>
                </div>
            </header>

            <!-- Loan Details Card -->
            <div
                class="card"
                style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(96, 165, 250, 0.1)); border-color: rgba(139, 92, 246, 0.3);"
            >
                <div
                    style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;"
                >
                    <div>
                        <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                            {
                                isLender
                                    ? `Pr√©stamo a ${loan.borrower_name}`
                                    : `Pr√©stamo de ${loan.lender_name || "Prestamista"}`
                            }
                        </h2>
                        <p
                            style="color: var(--text-secondary); margin: 0.25rem 0;"
                        >
                            {
                                isLender
                                    ? `üìß ${loan.borrower_email}`
                                    : `üìß ${loan.lender_email || ""}`
                            }
                        </p>
                        <p
                            style="color: var(--text-tertiary); font-size: 0.9rem;"
                        >
                            Creado el {formatDate(loan.created_at)}
                        </p>
                    </div>
                    <span class={`badge badge-${loan.status}`}>
                        {statusText[loan.status] || loan.status}
                    </span>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p
                        style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, hsl(260, 85%, 65%), hsl(200, 90%, 60%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0;"
                    >
                        {formatCurrency(loan.amount)}
                    </p>
                </div>

                <div
                    style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;"
                >
                    <p
                        style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;"
                    >
                        Descripci√≥n:
                    </p>
                    <p style="color: var(--text-primary); line-height: 1.6;">
                        {loan.description}
                    </p>
                </div>
            </div>

            <!-- Payment Section (only for accepted loans) -->
            {
                loan.status === "accepted" && (
                    <div
                        class="grid grid-2"
                        style="gap: 2rem; align-items: start;"
                    >
                        {/* Payment Form (only for borrower) */}
                        {isBorrower && balance && (
                            <PaymentForm
                                loanId={id}
                                balance={balance.balance}
                            />
                        )}

                        {/* Message for lender */}
                        {isLender && (
                            <div
                                class="card"
                                style="background: rgba(96, 165, 250, 0.1); border-color: rgba(96, 165, 250, 0.3);"
                            >
                                <h3 style="margin-bottom: 1rem; font-size: 1.25rem;">
                                    ‚ÑπÔ∏è Informaci√≥n
                                </h3>
                                <p style="color: var(--text-secondary); line-height: 1.6;">
                                    Como prestamista, puedes revisar y confirmar
                                    los pagos que el prestatario registre. Los
                                    pagos aparecer√°n en el historial de pagos a
                                    continuaci√≥n.
                                </p>
                            </div>
                        )}

                        {/* Payment History */}
                        <div style={isBorrower ? "" : "grid-column: 1 / -1;"}>
                            <PaymentHistory loanId={id} isLender={isLender} />
                        </div>
                    </div>
                )
            }

            {/* Message when loan is pending */}
            {
                loan.status === "pending" && (
                    <div
                        class="card"
                        style="background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3);"
                    >
                        <h3 style="margin-bottom: 1rem; font-size: 1.25rem; color: #fbbf24;">
                            ‚è≥ Pr√©stamo Pendiente de Aceptaci√≥n
                        </h3>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            {isBorrower
                                ? "Debes aceptar este pr√©stamo antes de poder registrar pagos. Ve al panel principal para aceptar o rechazar esta solicitud."
                                : "El prestatario a√∫n no ha aceptado este pr√©stamo. Una vez aceptado, podr√° comenzar a registrar pagos."}
                        </p>
                    </div>
                )
            }

            {/* Message when loan is rejected */}
            {
                loan.status === "rejected" && (
                    <div
                        class="card"
                        style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);"
                    >
                        <h3 style="margin-bottom: 1rem; font-size: 1.25rem; color: #ef4444;">
                            ‚ùå Pr√©stamo Rechazado
                        </h3>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            Este pr√©stamo fue rechazado y no se pueden registrar
                            pagos.
                        </p>
                    </div>
                )
            }

            {/* Returned loan - show completion message and payment history */}
            {
                loan.status === "returned" && (
                    <div>
                        <div
                            class="card"
                            style="text-align: center; background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); margin-bottom: 2rem;"
                        >
                            <p style="font-size: 1.5rem; color: #22c55e; margin: 0;">
                                ‚úÖ Pr√©stamo completamente pagado
                            </p>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                Este pr√©stamo ha sido pagado en su totalidad. A
                                continuaci√≥n puedes ver el historial completo de
                                pagos.
                            </p>
                        </div>

                        {/* Payment History for returned loans */}
                        <div>
                            <PaymentHistory loanId={id} isLender={isLender} />
                        </div>
                    </div>
                )
            }
        </div>

        <script>
            // Reload page when payment is confirmed
            window.addEventListener("payment-confirmed", () => {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            });
        </script>

        <style>
            @media (max-width: 968px) {
                .grid-2 {
                    grid-template-columns: 1fr !important;
                }
            }
        </style>
    </body>
</html>
